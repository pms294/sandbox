## ソースコード構成 (`src/`)

このプロジェクトは、機能ごとにモジュール化されています。

| ファイル | 役割 |
| :--- | :--- |
| **`main.c`** | プログラムのエントリーポイント。引数解析、各管理スレッドの起動、終了処理など、全体の統括を担当します。 |
| **`common.h`** | 全モジュールで共有される構造体、定数、グローバル変数の`extern`宣言を定義します。 |
| **`session.c` / `.h`** | SSHおよびSFTPの接続、認証、セッション管理といった低レベルな通信処理を担当します。 |
| **`transfer.c` / `.h`** | 実際にファイル転送を行うワーカースレッドのロジックと、それらのスレッドを生成する役割を担っています。 |
| **`optimizer.c` / `.h`** | 転送パフォーマンスを監視し、スループットを最大化するためにスレッド数を動的に調整するすべてのアルゴリズムを実装しています。 |
| **`monitor.c` / `.h`** | 転送の進捗状況（スループット、転送率など）を計算し、画面に表示したり、最終的なレポートを作成したりする役割です。 |

---

## 使い方

### 基本書式

```bash
./build/mscptest [オプション] <ローカルファイル> <[user@]host:リモートパス>
```

### コマンドラインオプション

| オプション | 引数 | 説明 | デフォルト値 |
| :--- | :--- | :--- | :--- |
| `-n` | `<数値>` | **並列転送スレッド（コネクション）数を固定します。** このオプションを指定すると、`-a`による動的なスレッド数最適化は行われず、常に指定された数のスレッドで転送を行います。 | 16 |
| `-a` | `<数値>` | **使用する最適化アルゴリズムを選択します。** このオプションを指定すると、転送状況を監視しながらスレッド数を動的に変更し、最適なスループットを目指します。指定しない場合、最適化は行われません。 | 0 (最適化なし) |
| `-s` | `<秒数>` | **最適化アルゴリズムがスループットを測定する間隔（秒）を設定します。** `-a`オプション使用時に有効です。この秒数ごとにパフォーマンスを評価し、次のアクションを決定します。 | 5秒 |
| `-f` | `<サイズ>` | **転送するファイルのサイズを仮想的に設定します。** `1G` (GB), `512M` (MB), `1024K` (KB) のように単位を指定できます。テストやデバッグで、実際のファイルサイズとは異なるサイズで転送をシミュレートしたい場合に使用します。 | なし (実際のファイルサイズを使用) |

#### 最適化アルゴリズム (`-a`) の種類

* `1`: **単純増加 (Simple Increase)** - スループットに関わらず、スレッド数を1つずつ増やし続けます。
* `2`: **単純な探索 (Most Naive)** - スループットが低下するまでスレッド数を増やし続けます。
* `3`: **山登り法 (Hill Climbing)** - スループットの改善率を評価し、改善が見られなくなったら探索を終了します。
* `4`: **勾配降下法 (Gradient Descent)** - スループットの変化率（勾配）を計算し、より効率的に最適なスレッド数を探索します。
* `5`: **ベイズ最適化 (Bayesian Optimization)** - 試行回数が少ない段階から効率的に最適値を探す高度な手法です。

#### 実験・デバッグ用オプション

| オプション | 引数 | 説明 |
| :--- | :--- | :--- |
| `-e` | `<数値>` | **スレッド数の増加を停止する上限値を設定します。** `-a 1` (単純増加) などと組み合わせて使用します。 |
| `-c` | `<数値>` | **SFTPコマンド遅延測定を有効にします。** 内部コマンドの応答時間を測定し、最適化に利用します。 |
| `-t` | `<マイクロ秒>` | **許容する最大遅延時間を設定します。** `-c`オプション使用時に有効です。 |
# sandbox
